<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>개인정보 수정</title>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/bar.css" />
    <link rel="stylesheet" href="/account-css/user-info-edit.css" />
    <link rel="stylesheet" href="/account-css/style.css" />
</head>
<body>
<!-- 상단, 사이드 바 등 필요 시 삽입 -->

<main class="container">
    <section class="content">
        <div class="profile-icon" style="text-align:center; margin-bottom:24px;">
            <i class="bi bi-person"></i>
        </div>

        <!-- 수정 폼 -->
        <form id="editForm" class="form-edit">
            <div class="form-field">
                <span id="email"></span>
            </div>

            <div class="form-field">
                <input type="text" id="name" placeholder="이름" class="rounded-input" required />
            </div>

            <div class="form-field">
                <input type="text" id="phonenum" placeholder="휴대폰 번호"
                       class="phonenum-input rounded-input" maxlength="13" required />
            </div>

            <div class="form-field" style="margin:12px 0 4px; text-align:center;">
                <input type="password" id="newPassword"
                       placeholder="새 비밀번호 (영문·숫자·특수문자 8~16자)"
                       minlength="8" maxlength="16" class="rounded-input"/>
            </div>

            <div class="form-field" style="margin:12px 0 4px; text-align:center;">
                <input type="password" id="confirmPassword" placeholder="새 비밀번호 확인"
                       class="rounded-input"/>
                <div id="error" style="color:red;"></div>
            </div>

            <div class="form-field" style="margin:12px 0 4px; text-align:center;">
                <a href="/account/remove" class="btn withdraw-btn" style="color: #ccc;">
                    회원탈퇴
                </a>
            </div>

            <div class="btn-group" style="margin-top:32px; text-align:center;">
                <button type="button" class="btn btn-cancel" onclick="window.location.href='/dashboard'">취소</button>
                <button type="submit" class="btn btn-quit">수정 완료</button>
            </div>
        </form>
    </section>
</main>

<script>
    axios.defaults.baseURL = 'http://127.0.0.1:8883';
    document.addEventListener("DOMContentLoaded", function () {
        const phoneInput = document.querySelector('.phonenum-input');
        const form = document.getElementById('editForm');

        // 전화번호 자동 하이픈
        phoneInput.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length < 4) {
                e.target.value = value;
            } else if (value.length < 8) {
                e.target.value = value.replace(/(\d{3})(\d{1,4})/, '$1-$2');
            } else {
                e.target.value = value.replace(/(\d{3})(\d{4})(\d{0,4})/, '$1-$2-$3');
            }
        });

        // 사용자 정보 조회
        axios.get('/api/member/info')
            .then(response => {
                const data = response.data;
                document.getElementById('email').textContent = data.email;
                document.getElementById('name').value = data.name;
                document.getElementById('phonenum').value = data.phonenum;
            })
            .catch(error => {
                alert("사용자 정보를 불러오지 못했습니다.");
                console.error(error);
            });

        // 사용자 정보 수정
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword && newPassword !== confirmPassword) {
                document.getElementById('error').textContent = "비밀번호가 일치하지 않습니다.";
                return;
            }

            const data = {
                name: document.getElementById('name').value,
                phonenum: document.getElementById('phonenum').value,
                newPassword: newPassword,
                confirmPassword: confirmPassword
            };

            axios.post('/api/member/info', data)
                .then(response => {
                    alert("회원 정보가 수정되었습니다.");
                    window.location.href = '/dashboard';
                })
                .catch(error => {
                    const message = error.response?.data || "오류가 발생했습니다.";
                    document.getElementById('error').textContent = message;
                });
        });
    });
</script>
</body>
</html>
