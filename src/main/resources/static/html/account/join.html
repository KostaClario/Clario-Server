<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>회원가입 - CLARIO</title>

    <!-- 아이콘 & 구글 폰트 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet"/>

    <!-- 공통 CSS -->
    <link rel="stylesheet" href="/account-css/style.css" />
</head>
<body>
<main class="consent-container">
    <!-- 왼쪽 브랜드 영역 -->
    <div class="left">
        <img src="/img/ClarioLogo.png" alt="CLARIO Logo">
    </div>

    <!-- 오른쪽 입력 영역 -->
    <div class="right2">
        <section class="content">
            <h2 style="text-align:center; margin-bottom:24px;">개인정보 입력</h2>
            <div class="form-edit" id="joinSection">
                <!-- 오류 메시지 -->
                <div id="errorMessage" style="color:red;"></div>

                <!-- 이름 -->
                <div class="form-field">
                    <input type="text" id="name" placeholder="이름" required />
                </div>

                <!-- 전화번호 -->
                <div class="form-field">
                    <input type="text" id="phonenum" placeholder="휴대폰번호 ( - 없이 입력)" required />
                </div>

                <!-- 비밀번호 -->
                <div class="form-field" style="margin-bottom:4px;">
                    <input type="password" id="newPassword"
                           placeholder="비밀번호 (영문자, 숫자, 특수문자 8~16자)"
                           minlength="8" maxlength="16" required />
                </div>

                <!-- 비밀번호 확인 -->
                <div class="form-field" style="margin:12px 0 4px;">
                    <input type="password" id="confirmPassword"
                           placeholder="비밀번호 확인" required />
                </div>

                <!-- 버튼 그룹 -->
                <div class="btn-group" style="margin-top:32px;">
                    <button type="button" class="btn btn-cancel" onclick="goToLogin()">다음에</button>
                    <button type="button" class="btn btn-quit" id="joinBtn">확인</button>
                </div>
            </div>
        </section>
    </div>
</main>

<!-- Axios CDN -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    // 기본 설정
    axios.defaults.baseURL = 'http://localhost:8883';
    axios.defaults.withCredentials = true; // 모든 요청에 쿠키 포함

    document.getElementById("joinBtn").addEventListener("click", async function () {
        const name = document.getElementById("name").value.trim();
        const phonenum = document.getElementById("phonenum").value.replace(/-/g, '').trim();
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.textContent = "";

        // 유효성 검사
        if (!name || !phonenum || !newPassword || !confirmPassword) {
            errorDiv.textContent = "모든 항목을 입력해주세요.";
            return;
        }

        const pwRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,16}$/;
        if (!pwRegex.test(newPassword)) {
            errorDiv.textContent = "비밀번호는 영문자, 숫자, 특수문자를 포함한 8~16자리여야 합니다.";
            return;
        }

        if (newPassword !== confirmPassword) {
            errorDiv.textContent = "비밀번호가 일치하지 않습니다.";
            return;
        }

        const data = { name, phonenum, newPassword, confirmPassword };

        try {
            const res = await axios.post("/api/member/join", data, {
                withCredentials: true // 쿠키 포함
            });

            console.log("서버 응답:", res.data);

            alert(res.data?.message || "가입 완료");
            location.href = res.data?.redirect || "/dashboard.html";
        } catch (err) {
            const status = err.response?.status;
            const msg = err.response?.data?.message || err.response?.data || "가입 중 오류가 발생했습니다.";
            alert(msg);

            if (status === 401) {
                location.href = "/html/account/login.html";
            } else {
                console.error("회원가입 실패:", err);
            }
        }
    });

    function goToLogin() {
        window.location.href = "/html/account/login.html"
    }
</script>
</body>
</html>
