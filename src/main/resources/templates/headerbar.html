<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>í—¤ë”ì™€ ì‚¬ì´ë“œë°”</title>
    <link rel="stylesheet" href="/account-css/style.css" />
    <link rel="stylesheet" href="/css/bar.css"/>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>

<!-- ì‚¬ì´ë“œë°” -->
<aside class="sidebar">
    <div class="logo">
        <img src="/img/ClarioLogoTextOnly.png" alt="CLARIO Logo">
    </div>
    <ul class="menu">
        <li><a class="nav-icon" href="/dashboard">ğŸ </a></li>
        <li><a class="nav-icon" href="/statistics">ğŸ“ˆ</a></li>
        <li><a class="nav-icon" href="/history">â˜°</a></li>
        <li><a class="nav-icon" href="/card">ğŸ’³</a></li>
    </ul>
</aside>

<!-- ìƒë‹¨ë°” -->
<header class="topbar">
    <div class="topbar-center" id="currentDate">ë‚ ì§œ ë¡œë”© ì¤‘â€¦</div>

    <div class="topbar-right">
        <span class="user-name" id="userName">ë¡œê·¸ì¸ ì‚¬ìš©ì</span>

        <!-- ë¡œê·¸ì•„ì›ƒ -->
        <form action="/logout" method="post" id="logoutForm">
            <button type="button" class="logout-btn"
                    onclick="document.getElementById('logoutForm').submit();">ë¡œê·¸ì•„ì›ƒ</button>
        </form>

        <!-- í”„ë¡œí•„ ì‚¬ì§„ + ë“œë¡­ë‹¤ìš´ -->
        <div class="profile-container" onclick="this.classList.toggle('hover')">
            <button class="profile-btn" id="profileBtn">
                <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì•„ì´ì½˜ -->
                <i class="bi bi-person" id="defaultProfileIcon"></i>
                <img src="" alt="í”„ë¡œí•„" class="profile-img" id="profileImg" style="display:none;" />
            </button>
            <div class="profile-menu">
                <button type="button" class="profile-menu-item" onclick="location.href='/mydata/mybankandcardlist'">
                    ìì‚° ì¡°íšŒ
                </button>
                <button type="button" class="profile-menu-item" onclick="openPwInputModal()">ì •ë³´ ìˆ˜ì •</button>
            </div>
        </div>
    </div>
</header>

<!-- ëª¨ë‹¬ ë“± ì•„ë˜ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ -->

<!-- ëª¨ë‹¬ Fragment -->
<div id="modals">
    <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="pwInputModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('pwInputModal')">&times;</span>
            <h2 style="text-align:center;">ë¹„ë°€ë²ˆí˜¸</h2>
            <div class="form-field" style="justify-content:center;">
                <input type="password" id="currentPassword" placeholder="Password" />
            </div>
            <div id="pwInputError" class="error-msg" style="display:none;">ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
            <div class="btn-group">
                <button class="btn btn-cancel" onclick="closeModal('pwInputModal')">ì·¨ì†Œ</button>
                <button class="btn" onclick="validatePassword()">í™•ì¸</button>
            </div>
            <div style="text-align:center; margin-top:8px;">
                <button class="btn-cancel" style="background:none; color:#ccc; border:none; cursor: pointer" onclick="openEmailModalFromPwInput()">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</button>
            </div>
        </div>
    </div>

    <!-- ì´ë©”ì¼ ì¸ì¦ ëª¨ë‹¬ -->
    <div id="emailModal" class="modal" data-email="">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('emailModal')">&times;</span>
            <h2 style="text-align:center;">ì´ë©”ì¼ ì¸ì¦</h2>
            <div class="form-field"><input type="text" id="email" readonly /></div>
            <div class="btn-group">
                <button id="sendCodeBtn" class="btn" onclick="sendVerificationEmail()">ì¸ì¦</button>
                <div id="timer" style="margin-top: 10px; font-weight: bold;"></div>
            </div>
            <div class="form-field" style="margin-top:16px;">
                <input type="text" id="emailCode" placeholder="ì¸ì¦ ì½”ë“œ ì…ë ¥" />
            </div>
            <div id="emailError" class="error-msg" style="display:none;">ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>
            <div class="btn-group">
                <button class="btn btn-cancel" onclick="closeModal('emailModal')">ì·¨ì†Œ</button>
                <button id="verifyBtn" class="btn" onclick="verifyEmailCode()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ëª¨ë‹¬ -->
    <div id="resetModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('resetModal')">&times;</span>
            <h2 style="text-align:center;">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</h2>
            <div class="form-field"><label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="newPassword" /></div>
            <div class="form-field"><label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input type="password" id="confirmNewPassword" /></div>
            <div id="resetError" class="error-msg" style="display:none;">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
            <div class="btn-group">
                <button class="btn btn-cancel" onclick="closeModal('resetModal')">ì·¨ì†Œ</button>
                <button class="btn" onclick="changePassword()">ë³€ê²½</button>
            </div>
        </div>
    </div>
</div>

<script src="/js/modal.js"></script>

<!-- ë‚ ì§œ í‘œì‹œ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    const today = new Date();
    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

    const year    = today.getFullYear();
    const month   = String(today.getMonth() + 1).padStart(2, '0');
    const date    = String(today.getDate()).padStart(2, '0');
    const weekday = days[today.getDay()];

    const formatted = `${year}/${month}/${date} ${weekday}`;

    const el = document.getElementById('currentDate');
    if (el) {
        el.textContent = formatted;
    }
</script>

<!-- ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° -->
<script>
    axios.get('/account/api/userinfo')
        .then(response => {
            const data = response.data;
            const userNameEl = document.getElementById('userName');
            const profileImg = document.getElementById('profileImg');
            const defaultIcon = document.getElementById('defaultProfileIcon');

            if (data && data.name) {
                userNameEl.textContent = data.name + 'ë‹˜';
            } else {
                userNameEl.textContent = 'ë¡œê·¸ì¸ ì‚¬ìš©ì';
            }

            if (data && data.profile) {
                profileImg.src = data.profile;
                profileImg.style.display = 'inline-block';
                if (defaultIcon) defaultIcon.style.display = 'none';
            } else {
                profileImg.style.display = 'none';
                if (defaultIcon) defaultIcon.style.display = 'inline-block';
            }
        })
        .catch(error => {
            console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        });
</script>

</body>
</html>
