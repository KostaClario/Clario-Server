<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLARIO - ì¹´ë“œ ì¶”ì²œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/bar.css}"/>
    <link rel="stylesheet" th:href="@{/account-css/modal.css}" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            /*font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;*/
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }
        
        .main-content {
            margin-left: 100px;
            padding: 90px 24px 24px 24px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .top-section {
            display: grid;
            grid-template-columns: 1fr 480px; /* ì°¨íŠ¸ ì˜ì—­ ì¤„ì´ê³  ì†Œë¹„íŒ¨í„´ ì˜ì—­ í™•ëŒ€ */
            gap: 24px;
        }

        .chart-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 28px; /* íŒ¨ë”© ì•½ê°„ ì¤„ì„ */
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .notification-section {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border-radius: 24px;
            padding: 32px; /* íŒ¨ë”© ì¦ê°€ */
            position: relative;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-height: 500px; /* ìµœì†Œ ë†’ì´ ì„¤ì • */
        }

        .notification-title {
            font-size: 18px; /* í°íŠ¸ í¬ê¸° ì¦ê°€ */
            font-weight: 700;
            color: #4338ca;
            margin-bottom: 20px; /* ë§ˆì§„ ì¦ê°€ */
            display: flex;
            align-items: center;
            gap: 8px;
            text-align: center;
        }

        .notification-content {
            font-size: 15px; /* í°íŠ¸ í¬ê¸° ì¦ê°€ */
            color: #4338ca;
            line-height: 1.6;
        }

        .consumption-analysis {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 18px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ì¦ê°€ */
            padding: 24px; /* íŒ¨ë”© ì¦ê°€ */
            margin-bottom: 24px; /* ë§ˆì§„ ì¦ê°€ */
            border: 1px solid rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
        }

        .analysis-header {
            text-align: center;
            font-weight: 700;
            font-size: 16px; /* í°íŠ¸ í¬ê¸° ì¦ê°€ */
            color: #4338ca;
            margin-bottom: 16px; /* ë§ˆì§„ ì¦ê°€ */
            padding-bottom: 12px; /* íŒ¨ë”© ì¦ê°€ */
            border-bottom: 1px dashed rgba(67, 56, 202, 0.3);
        }

        .analysis-date {
            text-align: center;
            font-weight: 600;
            font-size: 15px; /* í°íŠ¸ í¬ê¸° ì¦ê°€ */
            color: #4338ca;
            margin-bottom: 20px; /* ë§ˆì§„ ì¦ê°€ */
        }

        .category-list {
            margin-bottom: 20px; /* ë§ˆì§„ ì¦ê°€ */
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px; /* ë§ˆì§„ ì¦ê°€ */
            font-size: 14px; /* í°íŠ¸ í¬ê¸° ì¦ê°€ */
            color: #4338ca;
            padding: 8px 0; /* íŒ¨ë”© ì¶”ê°€ */
        }

        .category-name {
            display: flex;
            align-items: center;
            gap: 8px; /* ê°„ê²© ì¦ê°€ */
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px; /* ê°„ê²© ì¦ê°€ */
            margin-top: 20px; /* ë§ˆì§„ ì¦ê°€ */
            padding-top: 16px; /* íŒ¨ë”© ì¦ê°€ */
            border-top: 1px dashed rgba(67, 56, 202, 0.3);
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 14px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ì¦ê°€ */
            padding: 14px 16px; /* íŒ¨ë”© ì¦ê°€ */
            font-size: 13px; /* í°íŠ¸ í¬ê¸° ì¦ê°€ */
            color: #4338ca;
            backdrop-filter: blur(10px);
        }

        .stat-label {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px; /* ê°„ê²© ì¦ê°€ */
            margin-bottom: 6px; /* ë§ˆì§„ ì¦ê°€ */
        }

        .stat-value {
            font-weight: 700;
            font-size: 14px; /* í°íŠ¸ í¬ê¸° ì¦ê°€ */
        }

        .tip-box {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 14px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ì¦ê°€ */
            padding: 16px; /* íŒ¨ë”© ì¦ê°€ */
            margin-top: 16px; /* ë§ˆì§„ ì¦ê°€ */
            font-size: 13px; /* í°íŠ¸ í¬ê¸° ì¦ê°€ */
            color: #4338ca;
            display: flex;
            align-items: flex-start;
            gap: 10px; /* ê°„ê²© ì¦ê°€ */
            backdrop-filter: blur(10px);
        }

        .tip-icon {
            font-size: 18px; /* ì•„ì´ì½˜ í¬ê¸° ì¦ê°€ */
            flex-shrink: 0;
        }

        .tip-text {
            line-height: 1.6; /* ì¤„ ê°„ê²© ì¦ê°€ */
        }

        .recommendation-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 16px 24px; /* íŒ¨ë”© ì¦ê°€ */
            border-radius: 28px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ì¦ê°€ */
            font-size: 15px; /* í°íŠ¸ í¬ê¸° ì¦ê°€ */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            width: 100%;
            margin-top: 24px; /* ë§ˆì§„ ì¦ê°€ */
        }

        .recommendation-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
        }

        .bottom-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 32px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 24px;
            color: #1e293b;
            text-align: center;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 350px; /* ì°¨íŠ¸ ë†’ì´ ì¤„ì„ */
            margin: 0 auto;
        }

        .chart-layout {
            display: flex;
            align-items: flex-start;
            gap: 24px; /* ê°„ê²© ì¤„ì„ */
            height: 300px; /* ë†’ì´ ì¤„ì„ */
        }

        .chart-canvas-container {
            flex: 0 0 280px; /* í¬ê¸° ì¤„ì„ */
            height: 280px; /* ë†’ì´ ì¤„ì„ */
            position: relative;
        }

        .chart-tabs {
            display: flex;
            gap: 10px; /* ê°„ê²© ì¤„ì„ */
            margin-bottom: 20px; /* ë§ˆì§„ ì¤„ì„ */
            justify-content: center;
        }

        .chart-tab {
            padding: 10px 16px; /* íŒ¨ë”© ì¤„ì„ */
            border: 2px solid rgba(226, 232, 240, 0.8);
            border-radius: 20px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ì¤„ì„ */
            background: rgba(255, 255, 255, 0.8);
            font-size: 12px; /* í°íŠ¸ í¬ê¸° ì¤„ì„ */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .chart-tab.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-color: #6366f1;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .chart-tab:hover:not(.active) {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.15);
        }

        .legend {
            display: flex;
            flex-direction: column;
            gap: 8px; /* ê°„ê²© ì¤„ì„ */
            flex: 1;
            height: 280px; /* ë†’ì´ ì¤„ì„ */
            overflow: visible;
            padding-right: 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px; /* í°íŠ¸ í¬ê¸° ì¤„ì„ */
            padding: 10px 14px; /* íŒ¨ë”© ì¤„ì„ */
            border-radius: 10px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ì¤„ì„ */
            transition: all 0.3s ease;
            background: rgba(248, 250, 252, 0.8);
            border: 1px solid rgba(226, 232, 240, 0.5);
            backdrop-filter: blur(10px);
        }

        .legend-item:hover {
            background: rgba(99, 102, 241, 0.1);
            transform: translateX(4px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.15);
        }

        .legend-left {
            display: flex;
            align-items: center;
            gap: 10px; /* ê°„ê²© ì¤„ì„ */
        }

        .legend-color {
            width: 12px; /* í¬ê¸° ì¤„ì„ */
            height: 12px; /* í¬ê¸° ì¤„ì„ */
            border-radius: 50%;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .legend-percentage {
            font-weight: 700;
            color: #1e293b;
        }

        .legend-value {
            font-size: 11px; /* í°íŠ¸ í¬ê¸° ì¤„ì„ */
            color: #64748b;
            margin-top: 2px;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px; /* ê°„ê²© ì¤„ì„ */
            margin-top: 16px; /* ë§ˆì§„ ì¤„ì„ */
            padding: 12px; /* íŒ¨ë”© ì¤„ì„ */
            background: rgba(248, 250, 252, 0.8);
            border-radius: 14px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ì¤„ì„ */
            backdrop-filter: blur(10px);
        }

        .legend-dual {
            display: flex;
            align-items: center;
            gap: 8px; /* ê°„ê²© ì¤„ì„ */
            font-size: 13px; /* í°íŠ¸ í¬ê¸° ì¤„ì„ */
            font-weight: 600;
        }

        .legend-dual-color {
            width: 16px; /* í¬ê¸° ì¤„ì„ */
            height: 16px; /* í¬ê¸° ì¤„ì„ */
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .card-view-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 24px;
            color: #1e293b;
        }

        .filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .select {
            padding: 12px 16px;
            border: 2px solid rgba(226, 232, 240, 0.8);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        .select:hover {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.05);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.15);
        }

        .select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .filter-tag {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
        }

        .filter-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .filter-tag .close {
            cursor: pointer;
            font-weight: bold;
            padding: 4px 6px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .filter-tag .close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .card-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card-item {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 24px;
            border: 2px solid rgba(226, 232, 240, 0.5);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);

            /* ë†’ì´ í™•ì¥ */
            min-height: 150px; /* í•„ìš”ì— ë”°ë¼ 160~180pxê¹Œì§€ ì¡°ì • ê°€ëŠ¥ */
        }


        .card-item:hover {
            border-color: #6366f1;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.15);
            transform: translateY(-4px);
        }

        .card-logo {
            width: 189px;  /* 84 â†’ 126 â†’ 189 */
            height: 122px; /* 54 â†’ 81 â†’ 122 */
            /*border: 2px solid rgba(226, 232, 240, 0.5);*/
            /*border-radius: 24px;*/ /* í•„ìš” ì‹œ ì ìš© */
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.8);
            flex-shrink: 0;
            backdrop-filter: blur(10px);
        }


        .card-logo img {
            max-width: 120px;   /* ê¸°ì¡´ 96px â†’ ë” í¬ê²Œ */
            max-height: 64px;   /* ê¸°ì¡´ 51px â†’ ë” í¬ê²Œ */
            object-fit: contain;
        }


        .card-info {
            flex: 1;
        }

        .card-name {
            font-size: 17px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .card-bank {
            font-size: 13px;
            color: #6366f1;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .card-description {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .card-benefit {
            font-size: 14px;
            color: #64748b;
            line-height: 1.5;
        }

        .card-type-badge {
            display: inline-block;
            padding: 5px 13px;           /* ê¸°ì¡´ 4px 10px â†’ ì•½ 1.3ë°° */
            border-radius: 16px;         /* ê¸°ì¡´ 12px â†’ 16px */
            font-size: 15.6px;           /* ê¸°ì¡´ 12px â†’ 15.6px (ì†Œìˆ˜ì  ë°˜ì˜¬ë¦¼ ê°€ëŠ¥) */
            font-weight: 500;
            color: white;
            white-space: nowrap;
            text-align: center;
        }



        .card-type-badge.credit {
            background-color: #2563eb; /* íŒŒë€ìƒ‰ */
        }

        .card-type-badge.check {
            background-color: #10b981; /* ì´ˆë¡ìƒ‰ */
        }

        .card-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .details-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .details-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .loading {
            text-align: center;
            color: #64748b;
            padding: 24px;
            font-weight: 500;
        }

        .error-message {
            text-align: center;
            color: #dc2626;
            padding: 24px;
            font-weight: 500;
        }

        .recommended-cards-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 32px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 24px;
            display: none;
        }

        .category-section {
            margin-bottom: 40px;
        }

        .category-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .card-box {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(226, 232, 240, 0.5);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .card-box:hover {
            border-color: #6366f1;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
            transform: translateY(-4px);
        }

        .card-box img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 12px;
            margin-bottom: 16px;
            background: rgba(248, 250, 252, 0.8);
        }

        .card-title {
            font-size: 17px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .card-company {
            font-size: 13px;
            color: #6366f1;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .card-benefit {
            font-size: 14px;
            color: #64748b;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .card-link {
            display: inline-block;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .card-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .filter-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .reset-btn {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        @media (max-width: 1200px) {
            .top-section {
                grid-template-columns: 1fr;
            }

            .card-row {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }

            .main-content {
                margin-left: 60px;
                padding: 90px 16px 16px 16px;
            }

            .header {
                padding: 0 16px;
            }

            .nav-icon {
                width: 44px;
                height: 44px;
                font-size: 18px;
            }

            .card-item {
                flex-direction: column;
                text-align: center;
            }

            .chart-layout {
                flex-direction: column;
                height: auto;
            }

            .chart-canvas-container {
                width: 100%;
                flex: none;
            }

            .legend {
                width: 100%;
                height: auto;
                padding-right: 0;
            }

            .card-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .header-right .user-name {
                display: none;
            }

            .chart-container {
                height: auto;
            }

            .filters {
                flex-direction: column;
            }
        }
    </style>
</head>
<aside th:fragment="sidebar" class="sidebar">
    <div class="logo">
        <img src="/img/ClarioLogoTextOnly.png" alt="CLARIO Logo">
    </div>
    <ul class="menu">
        <li><a class="nav-icon" href="/dashboard">ğŸ </a></li>
        <li><a class="nav-icon" href="/statistics">ğŸ“ˆ</a></li>
        <li><a class="nav-icon" href="/history">â˜°</a></li>
        <li><a class="nav-icon active" href="/card">ğŸ’³</a></li>
    </ul>
</aside>
<div th:replace="~{headerside :: allModals}"></div>
<div th:replace="~{headerside :: header}"></div>
<body>
<div class="container">
    <main class="main-content">
        <div class="top-section">
            <section class="chart-section">
                <h2 class="section-title">ì†Œë¹„ ì¹´í…Œê³ ë¦¬ ë¶„ì„</h2>

                <div class="chart-tabs">
                    <div class="chart-tab active" id="dualTab" onclick="switchChart('dual')">ğŸ“Š í†µí•© ë¶„ì„</div>
                    <div class="chart-tab" id="amountTab" onclick="switchChart('amount')">ğŸ’° ê¸ˆì•¡ë³„</div>
                    <div class="chart-tab" id="countTab" onclick="switchChart('count')">ğŸ”¢ íšŸìˆ˜ë³„</div>
                </div>

                <div id="chartContainer" class="chart-container">
                    <canvas id="dualChart"></canvas>
                    <div id="doughnutLayout" class="chart-layout" style="display: none;">
                        <div class="chart-canvas-container">
                            <canvas id="doughnutChart"></canvas>
                        </div>
                        <div id="categoryLegend" class="legend">
                            <div class="loading">ë°ì´í„° ë¡œë”©ì¤‘...</div>
                        </div>
                    </div>
                </div>

                <div class="chart-legend" id="chartLegend" style="display: none;">
                    <div class="legend-dual">
                        <div class="legend-dual-color" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);"></div>
                        <span>ğŸ’° ê¸ˆì•¡ (ì›)</span>
                    </div>
                    <div class="legend-dual">
                        <div class="legend-dual-color" style="background: linear-gradient(135deg, #f472b6 0%, #ec4899 100%);"></div>
                        <span>ğŸ”¢ íšŸìˆ˜ (íšŒ)</span>
                    </div>
                </div>
            </section>

            <section class="notification-section">
                <div id="notificationContent">
                    <div class="consumption-analysis">
                        <div class="analysis-header">ì†Œë¹„ íŒ¨í„´ ë¶„ì„</div>
                        <div class="analysis-date">ğŸ—“ï¸ 2025ë…„ 6ì›” ì†Œë¹„ íŒ¨í„´ ë¶„ì„</div>
                        <div style="font-size: 14px; margin-bottom: 16px; font-weight: 600;">ìƒìœ„ ì¹´í…Œê³ ë¦¬:</div>
                        <div class="category-list">
                            <div class="category-item">
                                <div class="category-name">ğŸ® ì—¬ê°€ë¹„</div>
                                <div>327,000ì› (4íšŒ)</div>
                            </div>
                            <div class="category-item">
                                <div class="category-name">ğŸ’¡ ê³ ì •ë¹„</div>
                                <div>298,000ì› (3íšŒ)</div>
                            </div>
                            <div class="category-item">
                                <div class="category-name">ğŸ· ìœ í¥ë¹„</div>
                                <div>267,049ì› (5íšŒ)</div>
                            </div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-label">ğŸ’µ ì´ ì§€ì¶œ</div>
                                <div class="stat-value">892,049ì› / 12íšŒ</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">ğŸ“‰ ì „ì›” ëŒ€ë¹„</div>
                                <div class="stat-value">â–²15.2% ì¦ê°€</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">ğŸ“Š ì†Œë¹„ ë¹„ì¤‘</div>
                                <div class="stat-value">78% (ì´ ìˆ˜ì… ëŒ€ë¹„)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">ğŸ“† í‰ê·  ê²°ì œ ê°„ê²©</div>
                                <div class="stat-value">2.6ì¼</div>
                            </div>
                        </div>
                        <div class="tip-box">
                            <div class="tip-icon">ğŸ’¡</div>
                            <div class="tip-text">Tip: ê³ ì •ë¹„ê°€ ë†’ìŠµë‹ˆë‹¤. í†µì‹ ë¹„ ë¹„êµë¥¼ ê³ ë ¤í•´ë³´ì„¸ìš”.</div>
                        </div>
                    </div>
                </div>
                <button class="recommendation-btn" id="recommendCardBtn">ë§ì¶¤ ì¹´ë“œ ì¶”ì²œë°›ê¸°</button>
            </section>
        </div>

        <section class="recommended-cards-section" id="recommendedCardsSection">
            <h2 class="card-view-title">ğŸ¯ ë§ì¶¤ ì¶”ì²œ ì¹´ë“œ</h2>
            <div id="recommendedCardList"></div>
        </section>

        <section class="bottom-section">
            <h2 class="card-view-title">ì¹´ë“œ ë³´ê¸°</h2>

            <div class="filters">
                <select class="select" id="cardTypeFilter">
                    <option value="">ì¹´ë“œ ìœ í˜•</option>
                    <option value="ì‹ ìš©">ì‹ ìš©ì¹´ë“œ</option>
                    <option value="ì²´í¬">ì²´í¬ì¹´ë“œ</option>
                </select>
                <select class="select" id="benefitFilter">
                    <option value="">í˜œíƒ ì„ íƒ</option>
                    <option value="ì‹ë¹„">ì‹ë¹„</option>
                    <option value="êµí†µë¹„">êµí†µë¹„</option>
                    <option value="ì—¬ê°€ë¹„">ì—¬ê°€ë¹„</option>
                    <option value="ê³ ì •ë¹„">ê³ ì •ë¹„</option>
                    <option value="ìœ í¥ë¹„">ìœ í¥ë¹„</option>
                    <option value="ê±´ê°•ë¹„">ê±´ê°•ë¹„</option>
                    <option value="ìƒí™œë¹„">ìƒí™œë¹„</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
                <div class="filter-tags" id="filterTags"></div>
                <button class="reset-btn" id="resetFiltersBtn">ğŸ”„ í•„í„° ì´ˆê¸°í™”</button>
            </div>

            <div class="card-list" id="cardList">
                <div class="loading">ì¹´ë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </section>
    </main>
</div>

<script>
    const config = {
        timeout: 5000,
        colors: [
            'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',
            'linear-gradient(135deg, #f472b6 0%, #ec4899 100%)',
            'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
            'linear-gradient(135deg, #10b981 0%, #059669 100%)',
            'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',
            'linear-gradient(135deg, #f97316 0%, #ea580c 100%)'
        ],
        solidColors: ['#3b82f6', '#f472b6', '#f59e0b', '#10b981', '#8b5cf6', '#f97316']
    };

    let dualChart = null;
    let doughnutChart = null;
    let currentFilters = {
        cardType: '',
        categories: []
    };

    let chartData = {
        amountBased: [],
        countBased: []
    };
    let currentChartType = 'dual';

    // ë¡œë”© ìƒíƒœ ê´€ë¦¬
    let isLoadingChart = false;
    let isLoadingCards = false;

    // ì¹´í…Œê³ ë¦¬ë³„ ì´ëª¨ì§€ ë§¤í•‘
    const emojiMap = {
        'ì‹ë¹„': 'ğŸ½',
        'êµí†µë¹„': 'ğŸš—',
        'ê³ ì •ë¹„': 'ğŸ’¡',
        'ìœ í¥ë¹„': 'ğŸ·',
        'ì—¬ê°€ë¹„': 'ğŸ®',
        'ê±´ê°•ë¹„': 'ğŸ¥',
        'ê¸°íƒ€': 'ğŸ“¦',
        'ìƒí™œë¹„': 'ğŸ“±'
    };

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    const utils = {
        updateCurrentDate: () => {
            const dateString = new Date().toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                weekday: 'short'
            });
            document.getElementById('currentDate').textContent = dateString;
        }
    };

    // ì¹´ë“œ ë Œë”ë§ í•¨ìˆ˜ (ë°±ì—”ë“œì—ì„œ ê·¸ë£¹í™”ëœ ë°ì´í„° ë°›ìŒ)
    function renderGroupedCards(groupedCards) {
        console.log('ğŸ¨ ì¹´ë“œ ë Œë”ë§:', groupedCards);

        const container = document.getElementById('recommendedCardList');
        container.innerHTML = '';

        let hasCards = false;

        for (const [category, cards] of Object.entries(groupedCards)) {
            if (cards && cards.length > 0) {
                hasCards = true;
                const emoji = emojiMap[category] || 'ğŸ“Š';
                const groupHTML = `
                        <div class="category-section">
                            <h3 class="category-title">${emoji} ${category} ê´€ë ¨ ì¶”ì²œì¹´ë“œ</h3>
                            <div class="card-row">
                                ${cards.map(card => {
                    const cardTypeClass = {
                        'ì‹ ìš©': 'credit',
                        'ì²´í¬': 'check'
                    }[card.cardType] || 'default';
                    return `
        <div class="card-box">
            <img src="/img/card/${card.cardRecommendationId}.png"
                alt="${card.cardName || 'ì¹´ë“œ'}"
                onerror="this.onerror=null; this.src='data:image/svg+xml;base64,...'" />
            <div class="card-type-badge ${cardTypeClass}">${card.cardType}</div>
            <div class="card-title">${card.cardName || 'ì¹´ë“œëª… ì—†ìŒ'}</div>
            <div class="card-company">${card.cardCompany || card.bankName || 'ë°œê¸‰ì‚¬ ì •ë³´ ì—†ìŒ'}</div>
            <div class="card-benefit">${card.benefitSummary || card.benefit || 'í˜œíƒ ì •ë³´ ì—†ìŒ'}</div>
            <a href="${card.cardUrl || '#'}" target="_blank" class="card-link">ì¹´ë“œ ì‹ ì²­í•˜ê¸°</a>
        </div>
    `;
                }).join('')}

                            </div>
                        </div>
                    `;
                container.insertAdjacentHTML('beforeend', groupHTML);
            }
        }

        if (!hasCards) {
            container.innerHTML = '<div class="error-message">ì¶”ì²œí•  ìˆ˜ ìˆëŠ” ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        }

        document.getElementById('recommendedCardsSection').style.display = 'block';
    }

    // ì†Œë¹„ ì¹´í…Œê³ ë¦¬ ì°¨íŠ¸ ìƒì„±
    const createCategoryChart = async () => {
        if (isLoadingChart) return;
        isLoadingChart = true;

        try {
            const legendContainer = document.getElementById('categoryLegend');
            legendContainer.innerHTML = '<div class="loading">ë°ì´í„° ë¡œë”©ì¤‘...</div>';

            const now = new Date();
            const response = await axios.get('/api/statistics/top-category-stats', {
                params: {
                    year: now.getFullYear(),
                    month: now.getMonth() + 1
                },
                timeout: config.timeout
            });

            const data = response.data;
            chartData.amountBased = data.amountBased || [];
            chartData.countBased = data.countBased || [];

            if (chartData.amountBased.length === 0 && chartData.countBased.length === 0) {
                legendContainer.innerHTML = '<div class="error-message">ì†Œë¹„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                updateNotificationContent(null);
                return;
            }

            renderChart(currentChartType);
            updateNotificationContent(data);

        } catch (error) {
            console.error('ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨:', error.message);
            document.getElementById('categoryLegend').innerHTML = '<div class="error-message">ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
            updateNotificationContent(null);
        } finally {
            isLoadingChart = false;
        }
    };

    // ì•Œë¦¼ ë‚´ìš© ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    const updateNotificationContent = (data) => {
        const notificationContainer = document.getElementById('notificationContent');

        if (!data || !data.totalAmount) {
            notificationContainer.innerHTML = `
                    <div class="consumption-analysis">
                        <div class="analysis-header">ì†Œë¹„ íŒ¨í„´ ë¶„ì„</div>
                        <div style="text-align: center; color: #4338ca; padding: 20px;">
                            ì†Œë¹„ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.
                        </div>
                    </div>
                `;
            return;
        }

        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;

        // ì „ì›” ëŒ€ë¹„ ì¦ê°ë¥  ê³„ì‚°
        let growthRate = 0;
        let growthText = '0%';
        let growthIcon = 'â–';

        if (data.previousMonthAmount && data.previousMonthAmount > 0) {
            growthRate = ((data.totalAmount - data.previousMonthAmount) / data.previousMonthAmount * 100);
            growthText = (growthRate > 0 ? 'â–²' : 'â–¼') + Math.abs(growthRate).toFixed(1) + '%';
            growthIcon = growthRate > 0 ? 'â–²' : 'â–¼';
            growthText += growthRate > 0 ? ' ì¦ê°€' : ' ê°ì†Œ';
        }

        // ì†Œë¹„ ë¹„ì¤‘ ê³„ì‚°
        let spendingRatio = 0;
        let spendingRatioText = 'ê³„ì‚° ë¶ˆê°€';

        if (data.userIncome && data.userIncome > 0) {
            spendingRatio = (data.totalAmount / data.userIncome * 100);
            spendingRatioText = spendingRatio.toFixed(0) + '% (ì´ ìˆ˜ì… ëŒ€ë¹„)';
        }

        // í‰ê·  ê²°ì œ ê°„ê²© ê³„ì‚°
        let avgInterval = 'ê³„ì‚° ë¶ˆê°€';
        if (data.totalCount && data.totalCount > 0) {
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const interval = (daysInMonth / data.totalCount).toFixed(1);
            avgInterval = interval + 'ì¼';
        }

        // ìƒìœ„ ì¹´í…Œê³ ë¦¬ 3ê°œ ì¶”ì¶œ
        const top3Categories = data.amountBased ? data.amountBased.slice(0, 3) : [];

        let categoryBreakdown = '';
        if (top3Categories.length > 0) {
            categoryBreakdown = top3Categories.map(item => {
                const emoji = emojiMap[item.categoryName] || 'ğŸ“Š';
                const countItem = data.countBased ? data.countBased.find(count => count.categoryName === item.categoryName) : null;
                const usageCount = countItem ? countItem.usageCount : 0;
                return `
                        <div class="category-item">
                            <div class="category-name">${emoji} ${item.categoryName}</div>
                            <div>${(item.totalAmount || 0).toLocaleString()}ì› (${usageCount}íšŒ)</div>
                        </div>
                    `;
            }).join('');
        }

        // íŒ ìƒì„±
        let tipText = 'ì†Œë¹„ íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬ ë§ì¶¤í˜• ì¹´ë“œë¥¼ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.';
        if (top3Categories.length > 0) {
            const topCategory = top3Categories[0].categoryName;
            switch(topCategory) {
                case 'ê³ ì •ë¹„':
                    tipText = 'Tip: ê³ ì •ë¹„ê°€ ë†’ìŠµë‹ˆë‹¤. í†µì‹ ë¹„ë‚˜ ê³µê³¼ê¸ˆ í• ì¸ í˜œíƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.';
                    break;
                case 'ì‹ë¹„':
                    tipText = 'Tip: ì‹ë¹„ ì§€ì¶œì´ ë§ìŠµë‹ˆë‹¤. ìŒì‹ì ì´ë‚˜ ë°°ë‹¬ í• ì¸ í˜œíƒ ì¹´ë“œë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.';
                    break;
                case 'êµí†µë¹„':
                    tipText = 'Tip: êµí†µë¹„ ì§€ì¶œì´ ë§ìŠµë‹ˆë‹¤. ëŒ€ì¤‘êµí†µì´ë‚˜ ì£¼ìœ  í• ì¸ ì¹´ë“œë¥¼ ê³ ë ¤í•´ë³´ì„¸ìš”.';
                    break;
                case 'ì—¬ê°€ë¹„':
                    tipText = 'Tip: ì—¬ê°€ í™œë™ì´ í™œë°œí•˜ì‹œë„¤ìš”. ë¬¸í™”ìƒí™œì´ë‚˜ ì‡¼í•‘ í• ì¸ í˜œíƒì„ í™•ì¸í•´ë³´ì„¸ìš”.';
                    break;
                case 'ìœ í¥ë¹„':
                    tipText = 'Tip: ìœ í¥ë¹„ ì§€ì¶œì´ ë§ìŠµë‹ˆë‹¤. ì¹´í˜ë‚˜ ìˆ ì§‘ í• ì¸ í˜œíƒ ì¹´ë“œë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.';
                    break;
                case 'ìƒí™œë¹„':
                    tipText = 'Tip: ìƒí™œë¹„ ì§€ì¶œì´ ë§ìŠµë‹ˆë‹¤. ë§ˆíŠ¸ë‚˜ ìƒí•„í’ˆ í• ì¸ í˜œíƒ ì¹´ë“œë¥¼ í™œìš©í•´ë³´ì„¸ìš”.';
                    break;
                case 'ê±´ê°•ë¹„':
                    tipText = 'Tip: ê±´ê°• ê´€ë ¨ ì§€ì¶œì´ ë§ìŠµë‹ˆë‹¤. ë³‘ì›ë¹„, ì•½êµ­ ë˜ëŠ” í—¬ìŠ¤ì¥ í• ì¸ í˜œíƒ ì¹´ë“œë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.';
                    break;
                default:
                    tipText = `Tip: ${topCategory} ì§€ì¶œì´ ë§ìŠµë‹ˆë‹¤. ê´€ë ¨ í• ì¸ í˜œíƒì„ í™•ì¸í•´ë³´ì„¸ìš”.`;
            }
        }

        notificationContainer.innerHTML = `
                <div class="consumption-analysis">
                    <div class="analysis-header">ì†Œë¹„ íŒ¨í„´ ë¶„ì„</div>
                    <div class="analysis-date">ğŸ—“ï¸ ${currentYear}ë…„ ${currentMonth}ì›” ì†Œë¹„ íŒ¨í„´ ë¶„ì„</div>
                    ${top3Categories.length > 0 ? `
                        <div style="font-size: 14px; margin-bottom: 16px; font-weight: 600;">ìƒìœ„ ì¹´í…Œê³ ë¦¬:</div>
                        <div class="category-list">
                            ${categoryBreakdown}
                        </div>
                    ` : ''}
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">ğŸ’µ ì´ ì§€ì¶œ</div>
                            <div class="stat-value">${data.totalAmount.toLocaleString()}ì› / ${data.totalCount}íšŒ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ğŸ“‰ ì „ì›” ëŒ€ë¹„</div>
                            <div class="stat-value">${growthText}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ğŸ“Š ì†Œë¹„ ë¹„ì¤‘</div>
                            <div class="stat-value">${spendingRatioText}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ğŸ“† í‰ê·  ê²°ì œ ê°„ê²©</div>
                            <div class="stat-value">${avgInterval}</div>
                        </div>
                    </div>
                    <div class="tip-box">
                        <div class="tip-icon">ğŸ’¡</div>
                        <div class="tip-text">${tipText}</div>
                    </div>
                </div>
            `;
    };

    // ì°¨íŠ¸ ë Œë”ë§
    const renderChart = (type) => {
        const dualChartElement = document.getElementById('dualChart');
        const doughnutLayoutElement = document.getElementById('doughnutLayout');
        const chartLegendElement = document.getElementById('chartLegend');

        if (type === 'dual') {
            dualChartElement.style.display = 'block';
            doughnutLayoutElement.style.display = 'none';
            chartLegendElement.style.display = 'flex';
            renderDualChart();
        } else {
            dualChartElement.style.display = 'none';
            doughnutLayoutElement.style.display = 'flex';
            chartLegendElement.style.display = 'none';
            renderDoughnutChart(type);
        }
    };

    // ì´ì¤‘ ì¶• ì°¨íŠ¸ ë Œë”ë§ (ë” ì„¸ë ¨ë˜ê²Œ)
    const renderDualChart = () => {
        const amountData = chartData.amountBased;
        const countData = chartData.countBased;

        if (!amountData || !countData || amountData.length === 0 || countData.length === 0) {
            document.getElementById('dualChart').style.display = 'none';
            document.getElementById('chartLegend').style.display = 'none';
            document.getElementById('doughnutLayout').innerHTML = '<div class="error-message">í†µí•© ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            document.getElementById('doughnutLayout').style.display = 'block';
            return;
        }

        const categories = amountData.map(item => item.categoryName);
        const amounts = amountData.map(item => item.totalAmount || 0);
        const counts = categories.map(category => {
            const countItem = countData.find(item => item.categoryName === category);
            return countItem ? (countItem.usageCount || 0) : 0;
        });

        if (dualChart) dualChart.destroy();

        const ctx = document.getElementById('dualChart').getContext('2d');

        // ê·¸ë¼ë°ì´ì…˜ ìƒì„±
        const amountGradient = ctx.createLinearGradient(0, 0, 0, 400);
        amountGradient.addColorStop(0, 'rgba(59, 130, 246, 0.9)');
        amountGradient.addColorStop(1, 'rgba(29, 78, 216, 0.7)');

        const countGradient = ctx.createLinearGradient(0, 0, 0, 400);
        countGradient.addColorStop(0, 'rgba(244, 114, 182, 0.9)');
        countGradient.addColorStop(1, 'rgba(236, 72, 153, 0.7)');

        dualChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [
                    {
                        label: 'ê¸ˆì•¡ (ì›)',
                        data: amounts,
                        backgroundColor: amountGradient,
                        borderColor: '#3b82f6',
                        borderWidth: 0,
                        yAxisID: 'y',
                        borderRadius: 8,
                        borderSkipped: false,
                        barThickness: 'flex',
                        maxBarThickness: 50, // ë§‰ëŒ€ ë‘ê»˜ ì¤„ì„
                    },
                    {
                        label: 'íšŸìˆ˜ (íšŒ)',
                        data: counts,
                        backgroundColor: countGradient,
                        borderColor: '#f472b6',
                        borderWidth: 0,
                        yAxisID: 'y1',
                        borderRadius: 8,
                        borderSkipped: false,
                        barThickness: 'flex',
                        maxBarThickness: 50, // ë§‰ëŒ€ ë‘ê»˜ ì¤„ì„
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        cornerRadius: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label;
                                const value = context.parsed.y;
                                return label.includes('ê¸ˆì•¡') ?
                                    `${label}: ${value.toLocaleString()}ì›` :
                                    `${label}: ${value}íšŒ`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: {
                            font: { size: 12, weight: 600 }, // í°íŠ¸ í¬ê¸° ì¤„ì„
                            color: '#64748b'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'ê¸ˆì•¡ (ì›)',
                            font: { size: 12, weight: 700 }, // í°íŠ¸ í¬ê¸° ì¤„ì„
                            color: '#3b82f6'
                        },
                        ticks: {
                            callback: value => value.toLocaleString() + 'ì›',
                            color: '#3b82f6',
                            font: { weight: 600, size: 11 } // í°íŠ¸ í¬ê¸° ì¤„ì„
                        },
                        grid: {
                            color: 'rgba(59, 130, 246, 0.1)',
                            drawBorder: false
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'íšŸìˆ˜ (íšŒ)',
                            font: { size: 12, weight: 700 }, // í°íŠ¸ í¬ê¸° ì¤„ì„
                            color: '#f472b6'
                        },
                        ticks: {
                            callback: value => value + 'íšŒ',
                            color: '#f472b6',
                            font: { weight: 600, size: 11 } // í°íŠ¸ í¬ê¸° ì¤„ì„
                        },
                        grid: { drawOnChartArea: false }
                    }
                },
                animation: {
                    duration: 1500,
                    easing: 'easeInOutCubic'
                }
            }
        });
    };

    // ë„ë„› ì°¨íŠ¸ ë Œë”ë§ (ë” ì„¸ë ¨ë˜ê²Œ)
    const renderDoughnutChart = (type) => {
        const data = type === 'amount' ? chartData.amountBased : chartData.countBased;

        if (!data || data.length === 0) {
            document.getElementById('categoryLegend').innerHTML =
                `<div class="error-message">${type === 'amount' ? 'ê¸ˆì•¡' : 'íšŸìˆ˜'} ê¸°ì¤€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
            return;
        }

        const labels = data.map(item => item.categoryName);
        const values = data.map(item => type === 'amount' ? (item.totalAmount || 0) : (item.usageCount || 0));
        const total = values.reduce((sum, val) => sum + val, 0);

        if (total === 0) {
            document.getElementById('categoryLegend').innerHTML = '<div class="error-message">ë°ì´í„° ê°’ì´ ëª¨ë‘ 0ì…ë‹ˆë‹¤</div>';
            return;
        }

        const percentages = values.map(val => Math.round((val / total) * 100));
        const colors = config.solidColors.slice(0, labels.length);

        if (doughnutChart) doughnutChart.destroy();

        const ctx = document.getElementById('doughnutChart').getContext('2d');
        doughnutChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 4,
                    borderColor: '#ffffff',
                    cutout: '65%',
                    hoverBorderWidth: 6,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        cornerRadius: 12,
                        callbacks: {
                            label: (context) => {
                                const percentage = percentages[context.dataIndex];
                                const value = values[context.dataIndex];
                                const unit = type === 'amount' ? 'ì›' : 'íšŒ';
                                return `${labels[context.dataIndex]}: ${percentage}% (${value.toLocaleString()}${unit})`;
                            }
                        }
                    }
                },
                animation: {
                    duration: 1500,
                    easing: 'easeInOutCubic'
                }
            }
        });

        const legendContainer = document.getElementById('categoryLegend');
        legendContainer.innerHTML = '';

        labels.forEach((label, index) => {
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            const unit = type === 'amount' ? 'ì›' : 'íšŒ';
            legendItem.innerHTML = `
                    <div class="legend-left">
                        <div class="legend-color" style="background: ${colors[index]};"></div>
                        <div>
                            <div>${label}</div>
                            <div class="legend-value">${values[index].toLocaleString()}${unit}</div>
                        </div>
                    </div>
                    <span class="legend-percentage">${percentages[index]}%</span>
                `;
            legendContainer.appendChild(legendItem);
        });
    };

    // ì°¨íŠ¸ íƒ€ì… ì „í™˜
    const switchChart = (type) => {
        currentChartType = type;
        document.getElementById('dualTab').classList.toggle('active', type === 'dual');
        document.getElementById('amountTab').classList.toggle('active', type === 'amount');
        document.getElementById('countTab').classList.toggle('active', type === 'count');
        renderChart(type);
    };

    //ì¹´ë“œ ëª©ë¡ ë¡œë“œ
    const loadCards = async () => {
        if (isLoadingCards) return;
        isLoadingCards = true;

        try {
            let response;

            if (currentFilters.categories.length > 0 || currentFilters.cardType) {
                const requestData = { cardType: currentFilters.cardType || null };
                if (currentFilters.categories.length > 0) {
                    requestData.parentCategories = currentFilters.categories;
                }
                response = await axios.post('/api/card/filter', requestData, {
                    timeout: config.timeout,
                    headers: { 'Content-Type': 'application/json' }
                });
            } else {
                response = await axios.get('/api/card/all', { timeout: config.timeout });
            }

            const cards = response.data;
            const cardListContainer = document.getElementById('cardList');
            cardListContainer.innerHTML = '';

            const typeClassMap = {
                'ì‹ ìš©': 'credit',
                'ì²´í¬': 'check'
            };

            if (!cards || cards.length === 0) {
                cardListContainer.innerHTML = '<div class="error-message">ì¹´ë“œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            cards.forEach(card => {
                const cardTypeClass = typeClassMap[card.cardType] || 'default';

                const cardItem = document.createElement('div');
                cardItem.className = 'card-item';
                cardItem.innerHTML = `
                <div class="card-logo">
                    <img src="/img/card/${card.cardRecommendationId}.png"
                         alt="${card.cardName || 'ì¹´ë“œ'}"
                         onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OTk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkNBUkQ8L3RleHQ+PC9zdmc='">
                </div>
                <div class="card-info">
                    <div class="card-name">${card.cardName || 'ì¹´ë“œëª… ì •ë³´ ì—†ìŒ'}</div>
                    ${card.bankName ? `<div class="card-bank">${card.bankName}</div>` : ''}
                    ${card.cardType ? `<div class="card-type-badge ${cardTypeClass}">${card.cardType}</div>` : ''}
                    ${card.description ? `<div class="card-description">${card.description}</div>` : ''}
                    ${card.benefitSummary ? `<div class="card-benefit">ğŸ’³ ${card.benefitSummary}</div>` : ''}
                </div>
                <div class="card-actions">
                    ${card.cardUrl ?
                    `<button class="details-btn" onclick="window.open('${card.cardUrl}', '_blank')">ì¹´ë“œ ì‹ ì²­í•˜ê¸°</button>` :
                    `<button class="details-btn" disabled style="opacity: 0.5; cursor: not-allowed;">ì •ë³´ ì—†ìŒ</button>`
                }
                </div>
            `;
                cardListContainer.appendChild(cardItem);
            });

        } catch (error) {
            console.error('ì¹´ë“œ ì¡°íšŒ ì‹¤íŒ¨:', error);
            document.getElementById('cardList').innerHTML = '<div class="error-message">ì¹´ë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
        } finally {
            isLoadingCards = false;
        }
    };


    // í•„í„° ê´€ë ¨ í•¨ìˆ˜ë“¤
    const resetFilters = () => {
        currentFilters.cardType = '';
        currentFilters.categories = [];
        document.getElementById('cardTypeFilter').value = '';
        document.getElementById('benefitFilter').value = '';
        updateFilterTags();
        loadCards();
    };

    const updateFilterTags = () => {
        const filterTagsContainer = document.getElementById('filterTags');
        filterTagsContainer.innerHTML = '';
        currentFilters.categories.forEach(category => {
            const tag = document.createElement('div');
            tag.className = 'filter-tag';
            tag.innerHTML = `${category} <span class="close" onclick="removeFilter('${category}')">Ã—</span>`;
            filterTagsContainer.appendChild(tag);
        });
    };

    const removeFilter = (category) => {
        currentFilters.categories = currentFilters.categories.filter(cat => cat !== category);
        updateFilterTags();
        loadCards();
    };

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    document.addEventListener('DOMContentLoaded', async () => {
        utils.updateCurrentDate();

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        try {
            await Promise.all([
                createCategoryChart(),
                loadCards()
            ]);
        } catch (error) {
            console.error('ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        }

        // ì¹´ë“œ ì¶”ì²œ ë²„íŠ¼
        document.getElementById('recommendCardBtn').addEventListener('click', async () => {
            try {
                console.log('ğŸ¯ ì¹´ë“œ ì¶”ì²œ ì‹œì‘');

                let topCategories = [];
                if (chartData.amountBased && chartData.amountBased.length > 0) {
                    topCategories = chartData.amountBased.slice(0, 3).map(item => item.categoryName);
                }

                if (topCategories.length === 0) {
                    alert('ì¶”ì²œì„ ìœ„í•œ ì†Œë¹„ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                    return;
                }

                console.log('ğŸ“Š ìƒìœ„ ì¹´í…Œê³ ë¦¬:', topCategories);

                const response = await axios.post('/api/card/recommend/grouped', {
                    parentCategories: topCategories,
                    cardType: null
                }, {
                    headers: { 'Content-Type': 'application/json' },
                    timeout: config.timeout
                });

                const groupedCards = response.data || {};
                console.log('ğŸ’³ ê·¸ë£¹í™”ëœ ì¹´ë“œ ì‘ë‹µ:', groupedCards);

                if (Object.keys(groupedCards).length === 0) {
                    alert('ì¶”ì²œ ê°€ëŠ¥í•œ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                renderGroupedCards(groupedCards);

            } catch (error) {
                console.error('âŒ ì¹´ë“œ ì¶”ì²œ ì‹¤íŒ¨:', error);
                alert('ì¹´ë“œ ì¶”ì²œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ê¸°íƒ€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
        document.querySelectorAll('.nav-icon').forEach(icon => {
            icon.addEventListener('click', function() {
                document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });

        document.querySelector('.logout-btn').addEventListener('click', () => {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        });

        document.getElementById('cardTypeFilter').addEventListener('change', function() {
            currentFilters.cardType = this.value;
            loadCards();
        });

        document.getElementById('benefitFilter').addEventListener('change', function() {
            const selectedCategory = this.value;
            if (selectedCategory && !currentFilters.categories.includes(selectedCategory)) {
                currentFilters.categories.push(selectedCategory);
                updateFilterTags();
                loadCards();
            }
            this.value = '';
        });

        document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
    });
</script>
<script th:src="@{/js/modal.js}"></script>
</body>
</html>